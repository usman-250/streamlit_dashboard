<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>CodePen - Drag &amp; Drop File Uploader</title>
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style_drag.css') }}">

</head>
<body>
<form method="POST" enctype="multipart/form-data">
<!-- partial:index.partial.html -->
<h1>Upload Required Files</h1>

<div id="file-uploader1" class="wrapper js"></div>
<div id="file-uploader2" class="wrapper js"></div>
<div id="file-uploader3" class="wrapper js"></div>

<div align='center'  >  
	<button class="btn btn-primary" type="submit">Submit</button>

</div>  

<script type="text/template" id="file-uploader-template">
	<form class="js--upload-form is-droppable">
		<span class="text--center">
			<i class="fa fa-cloud-upload fa-2"></i>
			<span class="js--advanced-upload">Upload Job Description, or <label class="btn btn--link" for="file">browse</label></span>
			<input type="file" name="files[]" id="file" class="js--basic-upload hide" data-multiple-caption="{count} files selected" multiple="" accept=".pdf,.xlsx,.txt,.doc,.docs">
		</span>
		<table class="js--files-list" border="0"></table>
	</form>
</script>

<script type="text/template" id="document-item-view">
<td><a href="<%= data %>" download="<%= name %>" target="_blank"><%= name %></a></td>
<td><%= type %>
<td><button class="btn btn--link js--remove-file"><i class="fa fa-times-circle"></i></button></td>
</script>
<!-- partial -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/backbone.marionette/2.4.7/backbone.marionette.min.js'></script>
<script>

var isAdvancedUpload = function() {
  var div = document.createElement('div');
  return (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 'FormData' in window && 'FileReader' in window;
}();

var tests = {
	filereader	: typeof FileReader != 'undefined',
	dnd			: 'draggable' in document.createElement('span'),
	formdata	: !!window.FormData,
	progress	: "upload" in new XMLHttpRequest
};

var supports = {
	FileReader	: 'FileReader' in window // typeof FileReader != 'undefined'
};

var acceptedTypes = {
	'application/pdf'	: true,
	'image/png'			: true,
	'image/jpeg'		: true,
	'image/gif'			: true
};

const acceptedMimeTypes = {
	'.pdf'	: 'application/pdf',
	'.doc'	: 'application/msword',
	'.docx'	: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
	'.rtf'	: 'text/rtf',
	'.xls'	: '',
	'.xlsx'	: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
	'.csv'	: 'text/csv',
	'.jpg'	: 'image/jpeg',
	'.jpeg'	: 'image/jpeg',
	'.txt'	: 'text/plain'
};

var FileModel = Backbone.Model.extend({
	defaults: {
		name				: null,
		type				: null,
		size				: null,
		data				: null,
		lastModified		: null,
		lastModifiedDate	: null
	}
});

var FilesCollection = Backbone.Collection.extend({
	model	: FileModel,
	url		: null
});

var FileView = Marionette.ItemView.extend({
	tagName		: 'tr',
	model		: FileModel,

	template	: '#document-item-view',
	
	ui: {
		btnRemoveFile: '.js--remove-file'
	},
	
	events: {
		'click @ui.btnRemoveFile': 'btnRemoveFileClicked'
	},
	
	initialize: function() {
		console.log("FileView :: initialize", this.options);
	},
	
	onRender: function() {
		console.log("FileView :: onRender", this.model.toJSON());
	},
	
	btnRemoveFileClicked: function() {
		this.triggerMethod("remove:file", this.model);
	}
										  
});

var FilesListView = Marionette.CompositeView.extend({
	childViewContainer	: '.js--files-list',
	childView			: FileView,
	collection			: FilesCollection,
	template: '#file-uploader-template',

	onRender: function() {
	},
	
	ui: {
		basicUpload		: '.js--basic-upload',
		advancedUpload	: '.js--advanced-upload',
		form			: '.js--upload-form',
		fileInput		: 'input[type="file"]'
	},
	
	events: {
		'change @ui.fileInput'	: 'onFilesSelected',

	},

	
	initialize: function() {
		console.log("FilesListView :: initialize", this.options);
	},
	
	onChildviewRemoveFile: function(cv, model) {
		console.log("FilesListView :: onChildviewRemoveFile", cv, model);
		this.collection.remove(model);
	},
	
	onRender: function() {
		console.log("FilesListView :: onRender", this.collection.toJSON());
		
		if (isAdvancedUpload) {
			
			this.ui.advancedUpload.removeClass('hide');
			this.ui.basicUpload.addClass('hide');
			
			var $form = this.ui.form;
			$form
				.on('drag dragstart dragend dragover dragenter dragleave drop', function(e) {
					e.preventDefault();
					e.stopPropagation();
				})
				.on('dragover dragenter', function() {
					$form.addClass('is-dragover');
				})
				.on('dragleave dragend drop', function() {
					$form.removeClass('is-dragover');
				});
		
			$form.on('drop', this.onFilesDropped.bind(this));
			
		} else {
			
			this.ui.advancedUpload.addClass('hide');
			this.ui.basicUpload.removeClass('hide');

		}
	},
	

	onFilesSelected: function(e) {
		console.debug("onFilesSelected", e);
		this.triggerMethod("read:files", e.currentTarget.files);
	},
	
	onFilesDropped: function(e) {
		console.debug("onFilesDropped", e);

		this.triggerMethod("read:files", e.originalEvent.dataTransfer.files);
	},
	
	onReadFiles: function(files) {
		for (var i = 0; i < files.length; i++) {
			var fileModel = new FileModel(files[i]);
			this.triggerMethod("read:file", files[i], fileModel);
		}
	},

	onReadFile: function(file, fileModel) {
		var self = this;
			var reader = new FileReader();
			reader.onload = function(event) {
				var fileData = event.target.result;
				fileModel.set("data", fileData);
				console.log("fileModel:", fileModel.toJSON());
				self.collection.add(fileModel);
			};
			reader.readAsDataURL(file);

	}

})

var filesListView1 = new FilesListView({	el: '#file-uploader1', collection: new FilesCollection()});
var filesListView2 = new FilesListView({	el: '#file-uploader2', collection: new FilesCollection()});
var filesListView3 = new FilesListView({	el: '#file-uploader3', collection: new FilesCollection()});
filesListView1.render();
filesListView2.render();
filesListView3.render();

</script>
</form>   
</body>
</html>
